apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "opensearch.fullname" . }}-get-opensearch-ver
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": hook-succeeded,before-hook-creation
spec:
  template:
    metadata:
      name: {{ template "opensearch.fullname" . }}-get-opensearch-ver
      labels:
          {{ include "opensearch.labels.standard" . | nindent 8 }}
        component: update-resources
    spec:
      securityContext:
          {{- include "opensearch-service.globalPodSecurityContext" . | nindent 8 }}
          {{- with .Values.updateResourcesJob.securityContext }}
          {{- toYaml . | nindent 8 }}
          {{- end }}
      restartPolicy: Never
      serviceAccountName: {{ template "opensearch.fullname" . }}-get-opensearch-ver
      containers:
        - name: get-version
          image: {{ template "kubectl.image" . }}
          command:
            - "/bin/bash"
            - "-c"
            - |
              echo "[INFO] Getting OpenSearch version..."
              version=$(curl -s -u netcrk:crknet http://opensearch:9200 | grep -oP '"number" *: *"\K[0-9.]+' || echo "unknown")
              echo "[INFO] Detected version: $version"
              echo "[INFO] Creating/Updating ConfigMap..."
              kubectl create configmap opensearch-version --from-literal=version=$version -o yaml --dry-run=client | kubectl apply -f -
          securityContext:
            privileged: true
            allowPrivilegeEscalation: true
            capabilities:
              add: ["ALL"]
